#!/usr/bin/env bash
set -euo pipefail

#
# frankfetch — Mini "neofetch" personalizado do Franklin
# CMUS + infos do sistema + Gruvbox
#

# -------------------------------
#    Funções de utilidade
# -------------------------------

get_cmus_song() {
    if ! pgrep -x cmus >/dev/null 2>&1; then
        printf "No music playing"
        return
    fi

    local status
    status=$(cmus-remote -Q | awk '/^status/ { print $2 }')

    if [[ "$status" == "stopped" ]]; then
        printf "No music playing"
        return
    fi

    local artist title album
    artist=$(cmus-remote -Q | awk -F ' ' '/tag artist/ { $1=$2=""; print substr($0,3) }')
    title=$(cmus-remote -Q | awk -F ' ' '/tag title/ { $1=$2=""; print substr($0,3) }')
    album=$(cmus-remote -Q | awk -F ' ' '/tag album/ { $1=$2=""; print substr($0,3) }' | head -1)

    printf "%s - %s - %s" "$artist" "$title" "$album"
}

# -------------------------------
#        Variáveis
# -------------------------------

# Gruvbox (suave)
gruv_yellow="\e[38;5;214m"
gruv_green="\e[38;5;142m"
gruv_reset="\e[0m"

tab="    "        # indentação
tab2="${tab}${tab}${tab}${tab}${tab}"

user_host="${USER} on $(uname -n)"
os_name=$(grep "^PRETTY_NAME=" /etc/os-release | cut -d= -f2 | tr -d '"')
kernel_info=$(uname -sr)
machine=$(uname -m)
packages=$(pacman -Qq | wc -l)
wm="SwayWM"
uptime_human=$(uptime -p | sed 's/up //')
shell_name=$(basename "$SHELL")
song=$(get_cmus_song)

# -------------------------------
#          Output final
# -------------------------------

clear

# Header
echo -e "${tab2}${gruv_yellow}${user_host}${gruv_reset}"
echo

# Corpo
echo -e " ${tab} ${gruv_green}OS${gruv_reset}: ${os_name}"
echo -e " ${tab} ${gruv_green}Architecture${gruv_reset}: ${machine}"
echo -e " ${tab} ${gruv_green}Kernel${gruv_reset}: ${kernel_info}"
echo -e " ${tab} ${gruv_green}Packages${gruv_reset}: ${packages}"
echo -e " ${tab} ${gruv_green}WM${gruv_reset}: ${wm}"
echo -e " ${tab} ${gruv_green}Uptime${gruv_reset}: ${uptime_human}"
echo -e " ${tab} ${gruv_green}Shell${gruv_reset}: ${shell_name}"

echo
echo -e " ${tab} Talk is cheap. Show me the code."
echo

# Barra de cores Gruvbox
echo -e " ${tab} \e[48;5;124m   \e[0m\e[48;5;166m   \e[0m\e[48;5;214m   \e[0m\e[48;5;142m   \e[0m\e[48;5;109m   \e[0m"
echo
