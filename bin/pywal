#!/usr/bin/env bash
# Franklin Souza (@ffranksz)
# Script atualizado com suporte completo ao Sway + Pywal

set -euo pipefail

clear

# -------------------------------
# Função: checar dependências
# -------------------------------
check_dep() {
    local dep="$1"
    command -v "$dep" >/dev/null 2>&1 || {
        printf "Dependência faltando: %s\nInstale antes de continuar!\n" "$dep"
        exit 1
    }
}

check_dep wget
check_dep fzf
check_dep unzip
check_dep swaymsg   # necessário para aplicar wallpaper no Sway
check_dep wal

# -------------------------------
# Função: atualizar wallpaper no Sway
# -------------------------------
update_sway_wallpaper() {
    local WALLPAPER_PATH="$1"
    local CONFIG_FILE="$HOME/.config/sway/config"

    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo "Config do Sway não encontrada!"
        return 1
    fi

    # Atualiza a linha do wallpaper correspondente ao HDMI-A-1
    sed -i "s|^\s*output HDMI-A-1.*bg .*|output HDMI-A-1 bg $WALLPAPER_PATH stretch|g" "$CONFIG_FILE"

    # Recarrega o sway
    swaymsg reload >/dev/null 2>&1 || true

    echo "Wallpaper do Sway atualizado!"
}

# -------------------------------
# Preparação
# -------------------------------
mkdir -p "$HOME/Wallpapers"
DIR="$HOME/Wallpapers"

# -------------------------------
# Loop principal
# -------------------------------
while true; do
    clear

    printf "
 ██████╗ ██╗   ██╗██╗    ██╗ █████╗ ██╗     
 ██╔══██╗╚██╗ ██╔╝██║    ██║██╔══██╗██║     
 ██████╔╝ ╚████╔╝ ██║ █╗ ██║███████║██║     
 ██╔═══╝   ╚██╔╝  ██║███╗██║██╔══██║██║     
 ██║        ██║   ╚███╔███╔╝██║  ██║███████╗
 ╚═╝        ╚═╝    ╚══╝╚══╝ ╚═╝  ╚═╝╚══════╝

"
    # Variáveis para visualizar imagens
    IMG1="catimg -r2 -w$COLUMNS"
    IMG2="sxiv -g 512x512"

    printf "Wallpaper atual (Pywal): "
    sed -n 3p ~/.cache/wal/colors.sh || printf "Nenhum\n"

    printf "\nEscolha:\n"
    printf "[1] Wallpaper aleatório (Pywal)\n"
    printf "[2] Selecionar Wallpaper (Pywal)\n"
    printf "[3] Baixar WallPack\n"
    printf "[4] Sair\n\n"

    read -rp "Digite a opção: " SELECTION

    case "$SELECTION" in
        1|01)
            clear
            mapfile -t my_array < <(ls "$DIR")
            if [[ ${#my_array[@]} -eq 0 ]]; then
                echo "Nenhum wallpaper encontrado!"
                read -rp "ENTER para continuar..."
                continue
            fi

            RANDOM_WALLPAPER="$DIR/${my_array[$RANDOM % ${#my_array[@]}]}"

            wal -i "$RANDOM_WALLPAPER"
            $HOME/.config/dunst/launchdunst.sh
            wal-telegram --wal

            cp ~/.cache/wal/colors-kitty.conf ~/.config/kitty/theme.conf

            update_sway_wallpaper "$RANDOM_WALLPAPER"
            read -rp "ENTER para continuar..."
            ;;
        
        2|02)
            mapfile -t array < <(
                find "$DIR" -regextype posix-egrep -regex '.*\.(jpg|png)' |
                #fzf --preview="kitty +kitten icat --silent {}"
                fzf --preview="$IMG1 {}"
            )

            [[ ${#array[@]} -eq 0 ]] && continue

            SELECTED="${array[0]}"

            wal -i "$SELECTED"
            $HOME/.config/dunst/launchdunst.sh
            wal-telegram --wal

            cp ~/.cache/wal/colors-kitty.conf ~/.config/kitty/theme.conf

            update_sway_wallpaper "$SELECTED"
            read -rp "ENTER para continuar..."
            ;;
        
        3|03)
            clear
            wget -c "https://github.com/frannksz/wallpack/archive/refs/heads/main.zip"
            unzip main.zip
            mv wallpack-main/* "$DIR"/
            rm -rf main.zip wallpack-main
            echo "WallPack baixado!"
            read -rp "ENTER para continuar..."
            ;;
        
        4|04)
            clear
            exit 0
            ;;
    esac
done
